---
- name: TrueNAS Provision
  hosts: truenas
  gather_facts: yes
  become: yes
  vars_files:
    - vars/pools.yml
    - vars/datasets.yml
    - vars/users.yml

  tasks:
    - name: Install required packages
      ansible.builtin.package:
        name:
          - zfs-utils
          - smartmontools
        state: present

    - name: Create ZFS pool
      community.general.zpool:
        name: "{{ zfs_pool.name }}"
        vdevs: "{{ zfs_pool.vdevs }}"
        state: present
        properties: "{{ zfs_pool.properties | default({}) }}"
      vars:
        zfs_pool: "{{ pools.main }}"

    - name: Create ZFS datasets
      community.general.zfs:
        name: "{{ item.name }}"
        state: present
        extra_zfs_properties: "{{ item.properties | default({}) }}"
      loop: "{{ zfs_datasets }}"

    - name: Set up periodic scrub
      ansible.builtin.cron:
        name: "ZFS scrub {{ pools.main.name }}"
        job: "/usr/sbin/zpool scrub {{ pools.main.name }}"
        minute: "0"
        hour: "2"
        day: "1"
        user: root

    - name: Set up SMART testing
      ansible.builtin.cron:
        name: "SMART short test"
        job: "/usr/sbin/smartctl -t short /dev/{{ item }}"
        minute: "0"
        hour: "1"
        user: root
      loop: "{{ smart_devices | default([]) }}"

    - name: Set up SMART long test
      ansible.builtin.cron:
        name: "SMART long test"
        job: "/usr/sbin/smartctl -t long /dev/{{ item }}"
        minute: "0"
        hour: "2"
        weekday: "0"
        user: root
      loop: "{{ smart_devices | default([]) }}"

    - name: Create mount points
      ansible.builtin.file:
        path: "{{ item.mount_point }}"
        state: directory
        mode: '0755'
        owner: "{{ item.owner | default('root') }}"
        group: "{{ item.group | default('root') }}"
      loop: "{{ mount_points | default([]) }}"
      when: item.mount_point is defined